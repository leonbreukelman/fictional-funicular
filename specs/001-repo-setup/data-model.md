# Data Model: AI-Native Repository Setup

**Feature**: 001-repo-setup | **Date**: 2025-11-13  
**Purpose**: Define entities, relationships, and data structures for AI-native repository infrastructure

## Core Entities

### 1. Constitution

**Description**: Governance document defining principles, technology stack, workflow, and compliance rules

**Attributes**:
- `version` (string, semver): Constitution version (e.g., "1.0.0")
- `ratification_date` (date, ISO 8601): Original adoption date
- `last_amended_date` (date, ISO 8601): Most recent modification date
- `principles` (list[Principle]): Core governance principles (7 required)
- `stack_requirements` (StackRequirements): Technology constraints
- `workflow` (Workflow): Development process definition
- `governance_rules` (GovernanceRules): Amendment and compliance procedures

**Validation Rules**:
- Version MUST follow semantic versioning (MAJOR.MINOR.PATCH)
- Ratification date MUST be <= last_amended_date
- MUST contain exactly 7 principles per constitution v1.0.0
- Principles MUST include NON-NEGOTIABLE markers where applicable

**State Transitions**:
```
Draft → Ratified → Amended → Superseded
```

**Storage**: `.specify/memory/constitution.md` (Markdown with frontmatter)

**Relationships**:
- References StackRequirements (1:1)
- Defines Workflow (1:1)
- Enforces GovernanceRules (1:1)
- Validated by ConstitutionCheck (1:many)

---

### 2. Agent Definition

**Description**: Specification of AI agent role, responsibilities, and integration points

**Attributes**:
- `agent_id` (string, unique): Identifier (e.g., "orchestrator", "memory_agent")
- `agent_type` (enum): Type of agent (ORCHESTRATOR, MEMORY, WORKFLOW, CUSTOM)
- `role_description` (string): Purpose and responsibilities
- `constraints` (list[string]): Boundaries and limitations
- `integration_points` (list[IntegrationPoint]): External system connections
- `memory_keys` (list[string]): mem0 keys agent uses
- `mcp_capabilities` (list[string]): MCP protocol operations supported

**Validation Rules**:
- agent_id MUST be lowercase with underscores
- role_description MUST begin with "You are..." per constitution principle IV
- MUST have at least one integration_point
- memory_keys MUST follow namespace pattern: `<namespace>:<feature>:<context_type>`

**Storage**: `AGENTS.md` (Markdown sections per agent)

**Relationships**:
- Uses MemoryContext (1:many)
- Participates in MCPCoordination (many:1)
- Executes Workflow (many:many)

---

### 3. Prompt Template

**Description**: Reusable instruction pattern for AI agents with role assignment and examples

**Attributes**:
- `template_id` (string, unique): Identifier (e.g., "hardening_phase1")
- `role_assignment` (string): Opening role statement
- `chain_of_thought_steps` (list[Step]): Numbered reasoning sequence
- `few_shot_examples` (list[Example]): 1-3 concrete examples
- `input_schema` (dict): Expected input structure
- `output_schema` (dict): Expected output structure
- `verification_checklist` (list[string]): Self-verification items

**Validation Rules**:
- MUST include role_assignment starting with "You are..."
- chain_of_thought_steps MUST be numbered sequentially
- MUST have 1-3 few_shot_examples per constitution principle VI
- verification_checklist MUST have >0 items per principle VII

**Storage**: `copilot-instructions.md` (Markdown with structured sections)

**Relationships**:
- Stored in MemoryContext (many:many)
- Used by AgentDefinition (many:many)
- Instantiated in Workflow (many:many)

---

### 4. Memory Context

**Description**: Persistent agent knowledge stored in mem0 with namespace and metadata, including branch isolation for concurrent development

**Attributes**:
- `memory_id` (string, UUID): Unique identifier generated by mem0
- `memory_key` (string): Hierarchical key with branch namespace (namespace:branch:feature:context_type)
- `branch_name` (string): Git branch name for isolation (e.g., "001-repo-setup")
- `content` (string or dict): Stored information
- `metadata` (dict): Additional context (principle, feature, branch, timestamp)
- `vector_embedding` (list[float]): Semantic search vector (managed by mem0)
- `created_at` (datetime): Creation timestamp
- `expires_at` (datetime, optional): Expiration for temporary context

**Validation Rules**:
- memory_key MUST match pattern `^[a-z_]+:[0-9]{3}-[a-z-]+:[a-z_]+:[a-z_]+$` (includes branch)
- branch_name MUST match current git branch from `git branch --show-current`
- metadata MUST include "principle", "feature", and "branch" keys
- expires_at MUST be > created_at if present

**State Transitions**:
```
Active → Expired → Archived → Deleted (cleanup when branch merged)
```

**Storage**: mem0 backend (Qdrant vector store or file-based)

**Relationships**:
- Used by AgentDefinition (many:many)
- Contains PromptTemplate (many:many)
- Tracks SpecificationArtifact history (many:many)

**Example Key**: `ai-repo:001-repo-setup:spec:technical_context` (namespace:branch:feature:context_type)

---

### 5. Specification Artifact

**Description**: Generated document (spec.md, plan.md, tasks.md) following template structure

**Attributes**:
- `artifact_type` (enum): SPEC, PLAN, TASKS, CHECKLIST, RESEARCH
- `feature_number` (string, ###): Three-digit feature identifier
- `feature_name` (string): Short kebab-case name
- `branch_name` (string): Git branch (###-feature-name)
- `file_path` (path, absolute): Full path to artifact file
- `status` (enum): DRAFT, IN_PROGRESS, COMPLETE, ARCHIVED
- `created_at` (datetime): Initial generation timestamp
- `updated_at` (datetime): Last modification timestamp
- `constitution_compliance` (list[ComplianceCheck]): Validation results

**Validation Rules**:
- feature_number MUST be zero-padded 3 digits
- feature_name MUST be lowercase kebab-case
- branch_name MUST equal "{feature_number}-{feature_name}"
- file_path MUST be in `specs/{feature_number}-{feature_name}/` directory

**State Transitions**:
```
DRAFT → IN_PROGRESS → COMPLETE → ARCHIVED
```

**Storage**: File system at `specs/###-feature-name/`

**Relationships**:
- Validated by ConstitutionCheck (many:many)
- References MemoryContext (many:many)
- Part of Workflow (many:1)

---

### 6. Hardening Workflow Phase

**Description**: One of four code review phases with inputs, outputs, and gate approval

**Attributes**:
- `phase_number` (int, 1-4): Phase identifier
- `phase_name` (enum): INTAKE_STRATEGY, IMPLEMENTATION, RCI, VERIFICATION_DELIVERY
- `phase_inputs` (list[string]): Required inputs for phase
- `phase_outputs` (dict): Structured outputs produced
- `gate_approved` (bool): Whether phase gate passed
- `gate_approver` (string): User who approved gate
- `threat_model` (dict, optional): Phase 1 security analysis
- `critique` (dict, optional): Phase 3 multi-perspective review
- `test_cases` (list[TestCase], optional): Phase 4 generated tests

**Validation Rules**:
- phase_number MUST be 1, 2, 3, or 4
- gate_approved MUST be true before next phase starts
- Phase 1 MUST produce threat_model
- Phase 3 MUST produce critique
- Phase 4 MUST produce test_cases

**State Transitions**:
```
Pending → InProgress → Complete → Approved
```

**Storage**: In-memory during workflow, persisted in MemoryContext

**Relationships**:
- Part of HardeningWorkflow (many:1)
- Tracked in MemoryContext (1:many)

---

## Entity Relationships Diagram

```
┌──────────────┐
│ Constitution │
│   (1.0.0)    │
└──────┬───────┘
       │ validates
       │
       ↓
┌──────────────────┐     uses      ┌──────────────┐
│ Specification    │──────────────→│   Memory     │
│    Artifact      │                │   Context    │
└──────┬───────────┘                └──────┬───────┘
       │                                   │ stored in
       │ generates                         │
       ↓                                   ↓
┌──────────────────┐     uses      ┌──────────────┐
│     Workflow     │──────────────→│    Agent     │
│                  │                │  Definition  │
└──────┬───────────┘                └──────┬───────┘
       │                                   │
       │ executes                          │ uses
       ↓                                   ↓
┌──────────────────┐     contains   ┌──────────────┐
│    Hardening     │──────────────→│    Prompt    │
│ Workflow Phase   │                │   Template   │
└──────────────────┘                └──────────────┘
```

## Data Schemas

### ConstitutionCheck Schema

```json
{
  "principle_id": "I | II | III | IV | V | VI | VII",
  "principle_name": "string",
  "check_status": "PASS | FAIL | WARNING",
  "violation_details": "string (if FAIL)",
  "justification": "string (if FAIL and justified)"
}
```

### IntegrationPoint Schema

```json
{
  "system_name": "string (e.g., 'mem0', 'MCP', 'GitHub')",
  "integration_type": "API | CLI | SDK | FILE",
  "connection_details": {
    "endpoint": "string (optional)",
    "auth_method": "string (optional)",
    "config_file": "string (optional)"
  },
  "failure_mode": "GRACEFUL_DEGRADATION | RETRY | FAIL_FAST"
}
```

### Step Schema (Chain-of-Thought)

```json
{
  "step_number": "integer (1-based)",
  "description": "string",
  "inputs": ["string"],
  "transformations": ["string"],
  "outputs": ["string"]
}
```

### Example Schema (Few-Shot)

```json
{
  "example_number": "integer (1-3)",
  "scenario": "string (typical | edge_case | anti_pattern)",
  "input": "string or dict",
  "expected_output": "string or dict",
  "explanation": "string"
}
```

## Storage Locations

| Entity | Primary Storage | Backup/Cache |
|--------|----------------|--------------|
| Constitution | `.specify/memory/constitution.md` | mem0 (read-only) |
| Agent Definition | `AGENTS.md` | mem0 (for quick access) |
| Prompt Template | `copilot-instructions.md` | mem0 (versioned) |
| Memory Context | mem0 (Qdrant/file-based) | File system snapshots |
| Specification Artifact | `specs/###-name/*.md` | Git history |
| Hardening Workflow Phase | Runtime memory | mem0 (critique_history) |

## Data Lifecycle

### Constitution
- **Creation**: Manual or via `/speckit.constitution` command
- **Updates**: Via amendment process (PR to `.specify/memory/constitution.md`)
- **Versioning**: Semantic versioning with Sync Impact Report
- **Retention**: Permanent (all versions in Git history)

### Agent Definition
- **Creation**: Initial setup or via `/speckit.agent add`
- **Updates**: Manual edits to `AGENTS.md`
- **Validation**: On repository initialization and feature generation
- **Retention**: Permanent

### Prompt Template
- **Creation**: Initial setup or via template addition
- **Updates**: Manual edits to `copilot-instructions.md`
- **Versioning**: Tracked in mem0 with version metadata
- **Retention**: Permanent (current) + mem0 history (90 days)

### Memory Context
- **Creation**: Automatic on agent operations
- **Updates**: Append-only for history, overwrite for state
- **Expiration**: Based on `expires_at` or feature completion
- **Retention**: 90 days default, configurable per namespace

### Specification Artifact
- **Creation**: Via `/speckit.specify`, `/speckit.plan`, `/speckit.tasks`
- **Updates**: Manual edits or command re-runs
- **Validation**: Via `/speckit.checklist` before merge
- **Retention**: Permanent (merged features), 30 days (abandoned branches)

### Hardening Workflow Phase
- **Creation**: On code hardening invocation
- **Updates**: Progress through phases
- **Completion**: All phases approved
- **Retention**: Critique stored in mem0 for 90 days

## Data Migration Strategy

### Version Upgrades

When constitution or entity schemas change:

1. **Detect schema version** from metadata
2. **Apply migrations** in sequence (v1.0.0 → v1.1.0 → v2.0.0)
3. **Validate migrated data** against new schema
4. **Update version metadata** to current
5. **Log migration** in Sync Impact Report

### Backward Compatibility

- Constitution v1.x.x MUST support all v1.0.0 entities
- Breaking changes require MAJOR version bump
- Deprecation warnings for 90 days before removal
- Migration scripts in `.specify/scripts/migrations/`

## Performance Considerations

### mem0 Query Optimization

- **Namespace prefixes**: Enable efficient key filtering
- **Vector embeddings**: Pre-computed for fast similarity search
- **Batch operations**: Use `memory.add_bulk()` for >10 items
- **Result limits**: Default to 5, max 20 for context retrieval

### File System Performance

- **Read caching**: Constitution and templates loaded once per session
- **Write batching**: Group spec updates to minimize disk I/O
- **Git operations**: Use `--no-verify` for internal commits

### Expected Data Volumes

| Entity | Count | Growth Rate | Size per Item |
|--------|-------|-------------|---------------|
| Constitution | 1 | 1 version/quarter | ~20 KB |
| Agent Definitions | 5-10 | 1-2/year | ~5 KB |
| Prompt Templates | 20-50 | 5-10/year | ~2 KB |
| Memory Contexts | 1000+ | 50/feature | ~1 KB |
| Spec Artifacts | 100-500 | 10-20/month | ~10 KB |
| Workflow Phases | 100-200 | 5-10/week | ~5 KB |

## Conclusion

Data model supports all functional requirements (FR-001 through FR-015) with clear entity definitions, validation rules, and relationships. All entities align with constitution principles (I-VII) and enable self-verification through structured schemas and state transitions.
